<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
    <meta charset="UTF-8"/>
    <title id="cv-title"></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <style>
        /* CSS variables placed in root, this can be updated via JS if needed*/
        :root {
            --primary-color: #d902b9;
            --background-color: #1f1f1f;
            --text-light: #f7f7f7;
            --scale-factor: 1;
            --font-scale: 1;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', Arial, sans-serif;
            background: var(--background-color);
            color: var(--text-light);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        .wrapper {
            padding: 20mm 15mm;
            transform: scale(var(--scale-factor));
            transform-origin: top left;
        }

        .cv {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 2rem;
            position: relative;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: left;
        }

        .photo {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
        }

        #name {

            margin: 0;
        }

        #title {

            margin: 0;
        }

        #name {
            font-size: calc(38px * var(--font-scale));
        }

        #title {
            font-size: calc(24px * var(--font-scale));
        }

        h1 {
            font-size: calc(28px * var(--font-scale));
        }

        h2 {
            font-size: calc(18px * var(--font-scale));
        }

        h3, .label, .institution, .job .title, ul, p, div {
            font-size: calc(14px * var(--font-scale));
        }

        .divider {
            position: absolute;
            left: 50%;
            top: calc(200px + 2rem);
            bottom: 0;
            width: 2px;
            background: var(--primary-color);
        }

        .divider::before,
        .divider::after {
            content: "";
            position: absolute;
            left: 50%;
            width: 12px;
            height: 2px;
            background: var(--primary-color);
            transform: translateX(-50%);
        }

        .divider::before {
            top: 0;
        }

        .divider::after {
            bottom: 0;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .left, .right {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        h1, h2, h3 {
            margin: 0;
            text-transform: uppercase;
            color: var(--primary-color);
        }

        ul {
            list-style: disc inside;
            margin: 0;
            padding-left: 10px;
        }

        .label {
            font-weight: bold;
            color: var(--primary-color);
        }

        .bordered {
            position: relative;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        .bordered::before,
        .bordered::after {
            content: "";
            position: absolute;
            bottom: -3px;
            width: 2px;
            height: 6px;
            background: var(--primary-color);
            display: none;
        }

        .left .bordered::before {
            display: block;
            left: 0;
        }

        .right .bordered::after {
            display: block;
            right: 0;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            color: var(--primary-color);
            margin-top: 2px;
        }

        .info-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .info-content .label {
            font-weight: bold;
            color: var(--primary-color);
        }

        .job {
            margin-bottom: 10px;
        }

        .job .title {
            font-weight: bold;
            display: flex;
            margin-bottom: 2px;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            align-items: flex-end;
            gap: 10px;
        }

        .job-title {
            flex: 1;
            min-width: 0;
        }

        .job-title h2 {
            margin: 0;
            word-break: break-word;
        }

        .job-dates {
            flex-shrink: 0;
            text-align: right;
            white-space: nowrap;
        }


        .institution {
            font-style: italic;
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }

             html, body {
              height: 297mm; /* A4 height */
            }

            html {
                zoom: var(--scale-factor);
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .wrapper {
                transform: none !important;
                padding: 10mm 15mm;
            }
        }
    </style>

    <div class="wrapper">
        <div class="cv">
            <div class="header">
                <div id="photo" class="photo"></div>
                <div class="profile-info">
                    <h1 id="name"></h1>
                    <h2 id="title"></h2>
                </div>
            </div>
            <div class="content">
                <div class="left">
                    <section>
                        <div class="info-row">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <g fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M17.414 10.414C18 9.828 18 8.886 18 7s0-2.828-.586-3.414m0 6.828C16.828 11 15.886 11 14 11h-4c-1.886 0-2.828 0-3.414-.586m10.828 0Zm0-6.828C16.828 3 15.886 3 14 3h-4c-1.886 0-2.828 0-3.414.586m10.828 0Zm-10.828 0C6 4.172 6 5.114 6 7s0 2.828.586 3.414m0-6.828Zm0 6.828ZM13 7a1 1 0 1 1-2 0a1 1 0 0 1 2 0Z"/>
                                        <path stroke-linecap="round"
                                              d="M18 6a3 3 0 0 1-3-3m3 5a3 3 0 0 0-3 3M6 6a3 3 0 0 0 3-3M6 8a3 3 0 0 1 3 3m-4 9.388h2.26c1.01 0 2.033.106 3.016.308a14.9 14.9 0 0 0 5.33.118c.868-.14 1.72-.355 2.492-.727c.696-.337 1.549-.81 2.122-1.341c.572-.53 1.168-1.397 1.59-2.075c.364-.582.188-1.295-.386-1.728a1.89 1.89 0 0 0-2.22 0l-1.807 1.365c-.7.53-1.465 1.017-2.376 1.162q-.165.026-.345.047m0 0l-.11.012m.11-.012a1 1 0 0 0 .427-.24a1.49 1.49 0 0 0 .126-2.134a1.9 1.9 0 0 0-.45-.367c-2.797-1.669-7.15-.398-9.779 1.467m9.676 1.274a.5.5 0 0 1-.11.012m0 0a9.3 9.3 0 0 1-1.814.004"/>
                                        <rect width="3" height="8" x="2" y="14" rx="1.5"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="info-content">
                                <div class="label"><h2>Salary & Rate</h2></div>
                                <div id="salary"></div>
                                <div id="rate"></div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="info-row">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                       stroke-width="2">
                                        <circle cx="12" cy="8" r="5"/>
                                        <path d="M20 21a8 8 0 0 0-16 0"/>
                                    </g>
                                </svg>
                            </div>
                            <div class="info-content">
                                <div class="label"><h2>Experience Level</h2></div>
                                <div id="experience"></div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="info-row">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                          d="m13 12.175l2.25 2.25q.275.275.275.688t-.275.712q-.3.3-.712.3t-.713-.3L11.3 13.3q-.15-.15-.225-.337T11 12.575V9q0-.425.288-.712T12 8t.713.288T13 9zM12 6q-.425 0-.712-.288T11 5V4h2v1q0 .425-.288.713T12 6m6 6q0-.425.288-.712T19 11h1v2h-1q-.425 0-.712-.288T18 12m-6 6q.425 0 .713.288T13 19v1h-2v-1q0-.425.288-.712T12 18m-6-6q0 .425-.288.713T5 13H4v-2h1q.425 0 .713.288T6 12m6 10q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m8-10q0-3.35-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20t5.675-2.325T20 12m-8 0"/>
                                </svg>
                            </div>
                            <div class="info-content">
                                <div class="label"><h2>Availability</h2></div>
                                <div id="avail-days"></div>
                                <div id="avail-hours"></div>          
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="info-row">
                            <div class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <path fill="currentColor"
                                          d="M12 19.35q3.05-2.8 4.525-5.087T18 10.2q0-2.725-1.737-4.462T12 4T7.738 5.738T6 10.2q0 1.775 1.475 4.063T12 19.35m0 1.975q-.35 0-.7-.125t-.625-.375Q9.05 19.325 7.8 17.9t-2.087-2.762t-1.275-2.575T4 10.2q0-3.75 2.413-5.975T12 2t5.588 2.225T20 10.2q0 1.125-.437 2.363t-1.275 2.575T16.2 17.9t-2.875 2.925q-.275.25-.625.375t-.7.125M12 12q.825 0 1.413-.587T14 10t-.587-1.412T12 8t-1.412.588T10 10t.588 1.413T12 12"/>
                                </svg>
                            </div>
                            <div class="info-content">
                                <div class="label"><h2>Location</h2></div>
                                <div id="location"></div>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div class="label bordered"><h1>Skills</h1></div>
                        <ul id="skills"></ul>
                    </section>
                    <section>
                        <div class="label bordered"><h1>Education</h1></div>
                        <div id="education"></div>
                    </section>
                </div>
                <div class="right">
                    <section>
                        <div class="label bordered"><h1>Profile</h1></div>
                        <p id="description"></p>
                    </section>
                    <section>
                        <div class="label bordered"><h1>Work Experience</h1></div>
                        <div id="experience-list"></div>
                    </section>
                </div>
            </div>

            <div class="divider"></div>
        </div>
    </div>

    <script>
        /* === SCALE LOGIC === */
        const PX_PER_MM = 96 / 25.4, PAGE_W = 210 * PX_PER_MM, PAGE_H = 297 * PX_PER_MM, MIN_SCALE = .5;
        const rescale = () => {
            const wrap = document.querySelector('.wrapper');
            if (!wrap) return;
            document.documentElement.style.setProperty('--scale-factor', 1);
            requestAnimationFrame(() => {
                const st = getComputedStyle(wrap), padX = parseFloat(st.paddingLeft) + parseFloat(st.paddingRight),
                    padY = parseFloat(st.paddingTop) + parseFloat(st.paddingBottom);
                const scale = Math.min(1, (PAGE_W - padX) / wrap.scrollWidth, (PAGE_H - padY) / wrap.scrollHeight) * .99;
                document.documentElement.style.setProperty('--scale-factor', Math.max(MIN_SCALE, scale));
            });
        };
        window.addEventListener('load', rescale);
        document.fonts && document.fonts.ready.then(rescale);
        new ResizeObserver(rescale).observe(document.querySelector('.wrapper'));
        window.matchMedia('print').addListener(e => e.matches && rescale());

        /* === DATA === (safe defaults) */
        const cv={
            first_name: {{ first_name|default('')|tojson }},
            middle_name: {{ middle_name|default('')|tojson }},
            last_name: {{ last_name|default('')|tojson }},
            short_title: {{ short_title|default('')|tojson }},
            description: {{ description|default('')|tojson }},
            skills: {{ skills|default([])|tojson }},
            availability_days: {{ availability_days|default('')|tojson }},
            availability_hours: {{ availability_hours|default('')|tojson }},
            availability_timezone: {{ availability_timezone|default('')|tojson }},
            location: {{ location|default('')|tojson }},
            experience: {{ experience|default([])|tojson }},
            education: {{ education|default([])|tojson }},
            photo_base64: {{ photo_base64|default('')|tojson }},
            full_name: {{ full_name|default('')|tojson }},
            years_of_experience: {{ years_of_experience|default('')|tojson }},
            rate_per_hour: {{ rate_per_hour|default('')|tojson }}
        };

        const safe = v => v ?? '';
        const fmtDate = (sm, sy, em, ey) => {
            const start = sm && sy ? `${sm} ${sy}` : '';
            const end = em && ey ? `${em} ${ey}` : (start ? 'Present' : '');
            return start || end ? `${start}${end ? ` – ${end}` : ''}` : '';
        };

        /* === BIND === */
        document.title = `${cv.full_name} CV`;
        document.getElementById('cv-title').innerText = document.title;
        document.getElementById('photo').style.backgroundImage = `url('${safe(cv.photo_base64)}')`;
        document.getElementById('rate').innerText = `${cv.rate_per_hour ? cv.rate_per_hour : '?'} / hour + GST`;
        document.getElementById('experience').innerText = cv.years_of_experience ? `${cv.years_of_experience}+ years` : '';
        document.getElementById('avail-days').innerText = safe(cv.availability_days);
        document.getElementById('avail-hours').innerText = safe(cv.availability_hours);
        document.getElementById('avail-hours').innerText += safe(" "+ cv.availability_timezone);
        document.getElementById('location').innerText = safe(cv.location);
        document.getElementById('name').innerText = safe(cv.full_name);
        document.getElementById('title').innerText = safe(cv.short_title);
        document.getElementById('description').innerText = safe(cv.description);

        const skillsUl = document.getElementById('skills');
        (cv.skills || []).filter(Boolean).forEach(s => {
            const li = document.createElement('li');
            li.textContent = s;
            skillsUl.appendChild(li);
        });
        const eduWrap = document.getElementById('education');
        (cv.education || []).filter(Boolean).forEach(e => {
            const d = document.createElement('div');
            d.innerHTML = `<div class='label'><h2>${safe(e.description)}</h2></div><div class='institution'>${safe(e.institution)}</div>`;
            eduWrap.appendChild(d);
        });
        const expWrap = document.getElementById('experience-list');
        (cv.experience || []).filter(Boolean).forEach(j => {
            const div = document.createElement('div');
            div.className = 'job';

            let endMonth = j.end_month_short_name;
            let endYear = j.end_year;

            if ((!endMonth || !endYear) && j.duration_days && j.start_month_short_name && j.start_year) {
                const monthsMap = {
                    Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
                    Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
                };
                const reverseMonthsMap = [
                    'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
                ];

                const startDate = new Date(j.start_year, monthsMap[j.start_month_short_name], 1);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + parseInt(j.duration_days));

                endMonth = reverseMonthsMap[endDate.getMonth()];
                endYear = endDate.getFullYear();
            }

            div.innerHTML = `
            <div class="job-header">
                <div class="job-title"><h2>${safe(j.position)}</h2></div>
                <div class="job-dates"><span>${fmtDate(j.start_month_short_name, j.start_year, endMonth, endYear)}</span></div>
            </div>
            <div>${safe(j.company_name)}</div>
            ${j.location ? `<div>Location: ${safe(j.location)}</div>` : ''}
            `;

            const ul = document.createElement('ul');
            (j.tasks || [])
                .filter(Boolean)
                .forEach(t => {
                    const li = document.createElement('li');
                    li.textContent = t;
                    ul.appendChild(li);
                });
            div.appendChild(ul);
            expWrap.appendChild(div);
        });
        const getFontScale = (charCount) => {
            if (charCount > 1600) return 0.65;
            if (charCount > 1300) return 0.7;
            if (charCount > 1100) return 0.8;
            if (charCount > 900) return 0.85;
            if (charCount > 700) return 0.9;
            if (charCount > 500) return 0.95;
            return 1;
        };

        const updateFontScale = () => {
            const left = document.querySelector('.left');
            const right = document.querySelector('.right');
            if (!left || !right) return;

            const leftLen = (left.innerText || '').length;
            const rightLen = (right.innerText || '').length;

            const leftScale = getFontScale(leftLen);
            const rightScale = getFontScale(rightLen);

            const finalScale = Math.min(leftScale, rightScale);

            document.documentElement.style.setProperty('--font-scale', finalScale);
        };

        window.addEventListener('load', () => {
            rescale();
            updateFontScale();
        });

        new ResizeObserver(() => {
            rescale();
            updateFontScale();
        }).observe(document.querySelector('.wrapper'));

        document.fonts?.ready.then(() => {
            rescale();
            updateFontScale();
        });
    </script>
    </body>
</html>